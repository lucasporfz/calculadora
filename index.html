<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Calculadora — versão web</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f4f6f9; color:#111; padding:24px; }
    .card { max-width:980px; margin:18px auto; background:white; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    label { display:block; font-size:13px; color:#333; margin-bottom:6px; }
    input[type=number] { width:100%; padding:8px 10px; border-radius:8px; border:1px solid #ddd; font-size:14px; }
    .full { grid-column: 1 / -1; }
    .btn { padding:10px 14px; background:#2563eb; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn.gray { background:#6b7280; }
    .btn.green { background:#16a34a; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    .results-group { margin-top:14px; padding:12px; background:#fafafa; border:1px solid #eee; border-radius:10px; }
    .results-group h3 { margin:0 0 10px; font-size:16px; }
    .result { background:white; padding:12px; border-radius:8px; border:1px solid #eee; font-weight:600; }
    .muted { color:#666; font-weight:500; }
    .winner { border:2px solid #16a34a !important; box-shadow:0 0 0 3px rgba(22,163,74,0.15); }
    .pill { display:inline-block; font-size:11px; padding:3px 6px; border-radius:999px; background:#eef2ff; color:#3730a3; margin-left:6px; font-weight:700; }
    @media (max-width: 720px){ .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="card">
    <h2>Calculadora</h2>

    <div class="grid">
      <div>
        <label>Level</label>
        <input id="level" type="number" value="690">
      </div>

      <div>
        <label>Magic Level</label>
        <input id="magicLevel" type="number" value="48">
      </div>

      <div>
        <label>Distance</label>
        <input id="distance" type="number" value="150">
      </div>

      <div>
        <label>Pontos Wheel</label>
        <input id="pontosWheel" type="number" value="11">
      </div>

      <div>
        <label>Chance de crítico (%)</label>
        <input id="chanceCrit" type="number" step="0.01" value="12">
      </div>

      <div>
        <label>Chance ativação legs (%)</label>
        <input id="chanceLegs" type="number" step="0.01" value="0.98">
      </div>

      <div>
        <label>Base mas san (wheel + gemas) (%)</label>
        <input id="baseMasSan" type="number" step="0.1" value="7.5">
      </div>

      <div>
        <label>Flechas/hora</label>
        <input id="flechasHora" type="number" value="1650">
      </div>

      <div>
        <label>Holy weakness (%)</label>
        <input id="holyWeak" type="number" step="1" value="100">
      </div>

      <div>
        <label>Physical weakness (%)</label>
        <input id="physWeak" type="number" step="1" value="100">
      </div>

      <div class="full toolbar">
        <button class="btn green" id="calcBtn">Calcular</button>
        <button class="btn gray" id="copyBtn">Copiar resultados</button>
        <button class="btn" id="saveBtn">Salvar (CSV)</button>
        <button class="btn gray" id="clearBtn">Limpar</button>
        <span class="muted" id="statusText"></span>
      </div>
    </div>

    <div class="results-group" id="groupResumo">
      <h3>Resumo</h3>
      <div class="grid">
        <div class="result"><div>Level dmg: <span id="outF14">--</span></div></div>
        <div class="result"><div>Base dmg: <span id="outF15">--</span></div></div>
        <div class="result"><div>Chance crítico ajustada: <span id="outF16">--</span></div></div>
        <div class="result"><div>Bônus legs → avatar 3: <span id="outF17">--</span></div></div>
      </div>
    </div>

    <div class="results-group" id="groupStage4">
      <h3>Stage 4 <span class="pill" id="pillStage4" style="display:none">MAIOR</span></h3>
      <div class="grid">
        <div class="result" id="cardF20"><div>+4% base damage para Divine Caldera: <span id="outF20">--</span></div></div>
        <div class="result" id="cardF21"><div>+20% critical extra damage para Divine Caldera: <span id="outF21">--</span></div></div>
      </div>
    </div>

    <div class="results-group" id="groupStage5">
      <h3>Stage 5 <span class="pill" id="pillStage5" style="display:none">MAIOR</span></h3>
      <div class="grid">
        <div class="result" id="cardF24"><div>+3% critical hit chance para Divine Caldera: <span id="outF24">--</span></div></div>
        <div class="result" id="cardF25"><div>+10% Distance Fighting p/ spells: <span id="outF25">--</span></div></div>
        <div class="result full" id="cardF26"><div>+2 attack: <span id="outF26">--</span></div></div>
      </div>
    </div>

    <p class="muted" style="margin-top:10px">
      Excel ⇄ JavaScript: ARREDMULTB(x;1) ≈ arredondar ao inteiro mais próximo (Math.round), ARREDONDAR.PARA.BAIXO(x;0) ≈ Math.floor, ROUND() ≈ Math.round.
    </p>
  </div>

  <script>
    function getNum(id){
      const el = document.getElementById(id);
      const n = Number(String(el.value).replace(',', '.'));
      return Number.isFinite(n) ? n : 0;
    }
    // Percentual que vira FRAÇÃO (ex.: 12 => 0.12; 0,98 => 0.0098)
    function getPctFraction(id){
      let s = String(document.getElementById(id).value).trim().replace(',', '.');
      s = s.endsWith('%') ? s.slice(0,-1) : s;
      let n = Number(s);
      if(!Number.isFinite(n)) n = 0;
      return n / 100; // sempre tratamos como valor em %
    }
    // Percentual que vira MULTIPLICADOR (ex.: 100 => 1; 120 => 1.2)
    function getPctMultiplier(id){
      let s = String(document.getElementById(id).value).trim().replace(',', '.');
      s = s.endsWith('%') ? s.slice(0,-1) : s;
      let n = Number(s);
      if(!Number.isFinite(n)) n = 0;
      return n / 100;
    }
    function setText(id, text){ document.getElementById(id).innerText = text; }
    function mround(value, multiple){
      if(!Number.isFinite(value) || !Number.isFinite(multiple) || multiple === 0) return NaN;
      return Math.round(value / multiple) * multiple;
    }
    function clearHighlights(){
      ['cardF20','cardF21','cardF24','cardF25','cardF26'].forEach(id=>{
        document.getElementById(id).classList.remove('winner')
      });
      document.getElementById('pillStage4').style.display = 'none';
      document.getElementById('pillStage5').style.display = 'none';
    }

    // FÓRMULAS
    function calcF14(F2){
      if (F2 < 500)  return mround(F2/5, 1);
      if (F2 < 1100) return mround((F2-500)/6 + 100, 1);
      if (F2 < 1800) return mround((F2-1100)/7 + 200, 1);
      if (F2 < 2600) return mround((F2-1800)/8 + 300, 1);
      return mround((F2-2600)/9 + 400, 1);
    }
    function calcF15(F3, F8){ return Math.floor(F3*140*(1+F8)/25 + 140*(1+F8)/4); }
    function calcF16(F9, F7, F6){
      const p1 = Math.floor(F9*F7*6);
      const p2 = Math.floor(((F9*2) - p1) * F6);
      return (p1 + p2) / (F9*2);
    }
    function calcF17(F9, F7){
      const p1 = Math.floor(F9*F7*6);
      return (p1 * 15 / (F9*2)) / 100;
    }
    function calcF20(F14, F3, F8, F5, F16, F17){
      const baseRight = Math.floor(F3*140*(1+F8+0.04)/25 + 140*(1+F8+0.04)/4);
      return (F14 + baseRight + F5) * (1 + (F16)*0.8 + F17);
    }
    function calcF21(F14, F15, F5, F16, F17){
      return (F14 + F15 + F5) * (1 + (F16 + F17));
    }
    function calcF24(F14, F15, F5, F11){ return (F14 + F15 + F5) * 0.03 * 0.25 * F11; }
    function calcF25(F21, F20, F4, F11){
      const base = Math.round(F4*0.1);
      const mult = (F21 > F20) ? (0.2485*1.12 + 0.0435*1.0864) : (0.2485*1.096 + 0.0435*1.0864);
      return base * mult * F11;
    }
    function calcF26(F4, F12){
      const innerA = Math.floor((6/5)*48);
      const innerB = Math.floor((6/5)*46);
      const termA = Math.floor(innerA * (Math.floor(F4) + 4) / 28);
      const termB = Math.floor(innerB * (Math.floor(F4) + 4) / 28);
      const diff = termA - termB;
      return diff * 0.5 * 1.0864 * F12;
    }

    function rodarCalculadora(){
      const F2  = getNum('level');
      const F3  = getNum('magicLevel');
      const F4  = getNum('distance');
      const F5  = getNum('pontosWheel');
      const F6  = getPctFraction('chanceCrit');
      const F7  = getPctFraction('chanceLegs');
      const F8  = getPctFraction('baseMasSan');
      const F9  = getNum('flechasHora');
      const F11 = getPctMultiplier('holyWeak');
      const F12 = getPctMultiplier('physWeak');

      const F14 = calcF14(F2);
      const F15 = calcF15(F3, F8);
      const F16 = calcF16(F9, F7, F6);
      const F17 = calcF17(F9, F7);
      const F20 = calcF20(F14, F3, F8, F5, F16, F17);
      const F21 = calcF21(F14, F15, F5, F16, F17);
      const F24 = calcF24(F14, F15, F5, F11);
      const F25 = calcF25(F21, F20, F4, F11);
      const F26 = calcF26(F4, F12);

      setText('outF14', F14);
      setText('outF15', F15);
      setText('outF16', (F16*100).toFixed(4) + ' %');
      setText('outF17', (F17*100).toFixed(4) + ' %');
      setText('outF20', Number(F20.toFixed(6)));
      setText('outF21', Number(F21.toFixed(6)));
      setText('outF24', Number(F24.toFixed(6)));
      setText('outF25', Number(F25.toFixed(6)));
      setText('outF26', Number(F26.toFixed(6)));

      try{ localStorage.setItem('calc_state', JSON.stringify({F2,F3,F4,F5,F6,F7,F8,F9,F11,F12})); }catch(e){}

      // Destaques
      clearHighlights();
      const winnerStage4 = (F20 >= F21) ? 'cardF20' : 'cardF21';
      document.getElementById(winnerStage4).classList.add('winner');
      document.getElementById('pillStage4').style.display = 'inline-block';

      let winner5 = 'cardF24'; let max5 = F24;
      if(F25 > max5){ winner5='cardF25'; max5=F25; }
      if(F26 > max5){ winner5='cardF26'; max5=F26; }
      document.getElementById(winner5).classList.add('winner');
      document.getElementById('pillStage5').style.display = 'inline-block';
    }

    const ids = ['level','magicLevel','distance','pontosWheel','chanceCrit','chanceLegs','baseMasSan','flechasHora','holyWeak','physWeak'];
    ids.forEach(id => { document.getElementById(id).addEventListener('input', rodarCalculadora); });

    document.getElementById('calcBtn').addEventListener('click', rodarCalculadora);
    document.getElementById('clearBtn').addEventListener('click', () => {
      ids.forEach(id => document.getElementById(id).value = '');
      ['outF14','outF15','outF16','outF17','outF20','outF21','outF24','outF25','outF26'].forEach(id => setText(id, '--'));
      try{ localStorage.removeItem('calc_state'); }catch(e){}
      clearHighlights();
      document.getElementById('statusText').innerText = '';
    });
    document.getElementById('copyBtn').addEventListener('click', async () => {
      const txt = [
        'Level dmg: ' + document.getElementById('outF14').innerText,
        'Base dmg: ' + document.getElementById('outF15').innerText,
        'Chance crítico ajustada: ' + document.getElementById('outF16').innerText,
        'Bônus legs→avatar3: ' + document.getElementById('outF17').innerText,
        'Stage 4 (+4% base dmg crit): ' + document.getElementById('outF20').innerText,
        'Stage 4 (+20% crit extra): ' + document.getElementById('outF21').innerText,
        'Stage 5 (+3% crit chance): ' + document.getElementById('outF24').innerText,
        'Stage 5 (+10% DF spells): ' + document.getElementById('outF25').innerText,
        'Stage 5 (+2 attack): ' + document.getElementById('outF26').innerText,
      ].join('\n');
      try{ await navigator.clipboard.writeText(txt); document.getElementById('statusText').innerText = 'Resultados copiados ✔'; setTimeout(()=> document.getElementById('statusText').innerText='',1500);}catch(e){}
    });
    document.getElementById('saveBtn').addEventListener('click', () => {
      const s = {
        F2: getNum('level'), F3: getNum('magicLevel'), F4: getNum('distance'),
        F5: getNum('pontosWheel'), F6: getNum('chanceCrit'), F7: getNum('chanceLegs'),
        F8: getNum('baseMasSan'), F9: getNum('flechasHora'), F11: getNum('holyWeak'), F12: getNum('physWeak')
      };
      const o = {
        F14: document.getElementById('outF14').innerText,
        F15: document.getElementById('outF15').innerText,
        F16: document.getElementById('outF16').innerText,
        F17: document.getElementById('outF17').innerText,
        F20: document.getElementById('outF20').innerText,
        F21: document.getElementById('outF21').innerText,
        F24: document.getElementById('outF24').innerText,
        F25: document.getElementById('outF25').innerText,
        F26: document.getElementById('outF26').innerText,
      };
      const headers = Object.keys(s).concat(Object.keys(o));
      const values  = Object.values(s).concat(Object.values(o));
      const csv = headers.join(',') + '\n' + values.join(',');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const now = new Date().toISOString().replaceAll(':','-').slice(0,19);
      a.href = url; a.download = 'calculadora-' + now + '.csv';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 0);
    });

    // restaurar estado salvo e rodar ao abrir
    (function restoreAndRun(){
      try{
        const raw = localStorage.getItem('calc_state');
        if(raw){
          const st = JSON.parse(raw);
          const set = (id, val) => { if (val !== undefined && val !== null) document.getElementById(id).value = val; };
          set('level', st.F2); set('magicLevel', st.F3); set('distance', st.F4); set('pontosWheel', st.F5);
          set('chanceCrit', st.F6); set('chanceLegs', st.F7); set('baseMasSan', st.F8); set('flechasHora', st.F9);
          set('holyWeak', st.F11); set('physWeak', st.F12);
        }
      }catch(e){}
      rodarCalculadora();
    })();
  </script>
</body>
</html>
