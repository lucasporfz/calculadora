<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Calculadora Perks Sanguine Bow — versão web</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* Base */
    body { font-family: Inter, Arial, sans-serif; background:#f4f6f9; color:#111; padding:24px; }
    .card { max-width:980px; margin:18px auto; background:white; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    label { display:block; font-size:13px; color:#333; margin-bottom:6px; }
    input[type=number] { width:100%; padding:8px 10px; border-radius:8px; border:1px solid #ddd; font-size:14px; }
    .full { grid-column: 1 / -1; }
    .btn { padding:10px 14px; background:#2563eb; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn.gray { background:#6b7280; }
    .btn.small { padding:8px 10px; font-size:13px; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    .results-group { margin-top:14px; padding:12px; background:#fafafa; border:1px solid #eee; border-radius:10px; }
    .results-group h3 { margin:0 0 10px; font-size:16px; }
    .result { background:white; padding:12px; border-radius:8px; border:1px solid #eee; font-weight:600; }
    .muted { color:#666; font-weight:500; }
    .pill { display:inline-block; font-size:11px; padding:3px 6px; border-radius:999px; background:#eef2ff; color:#3730a3; margin-left:6px; font-weight:700; }

    /* NOVO: lista de perks em 2 colunas (nome | valor) */
    .perk-list{ list-style:none; padding:0; margin:0; display:grid; gap:12px; }
    .perk-card{
      position:relative;
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:14px;
      background:white;
      border:1px solid #eee;
      border-radius:10px;
      padding:12px 14px;
      transition: background .15s ease, border-color .15s ease, box-shadow .15s ease;
    }
    .perk-card:hover{ background:#fbfbff; border-color:#dfe6ff; }
    .perk-card__name{
      color:#111; font-weight:600;
      font-size:clamp(.92rem, 1.6vw, 1rem);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .perk-card__value{ display:flex; align-items:flex-end; gap:4px; justify-self:end; text-align:right; line-height:1; }
    .perk-card__num{
      font-size:clamp(1rem, 2.2vw, 1.25rem);
      font-weight:800; color:#111;
      font-variant-numeric: tabular-nums lining-nums; /* números estáveis */
    }

    /* Destaque do vencedor do stage */
    .perk-card.is-best{
      border:2px solid #16a34a;
      box-shadow:0 0 0 3px rgba(22,163,74,.15);
    }
    .perk-card__badge{
      display:none;
      position:absolute; top:-10px; right:10px;
      background:#16a34a; color:#062b1e; font-weight:800;
      padding:2px 8px; border-radius:999px; font-size:.72rem;
      box-shadow:0 6px 16px rgba(16,185,129,.35);
    }
    .perk-card.is-best .perk-card__badge{ display:inline-block; }

    @media (max-width: 720px){
      .grid { grid-template-columns: 1fr; }
      .perk-card{ grid-template-columns: 1fr; }
      .perk-card__value{ justify-self:start; margin-top:4px; }
      .perk-card__num{ font-size:clamp(1.05rem, 5vw, 1.35rem); }
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header"><h2>Calculadora Perks Sanguine Bow</h2><button class="btn gray small" id="langBtn">English</button></div>

    <div class="grid">
      <div>
        <label>Level</label>
        <input id="level" type="number" value="1500">
      </div>

      <div>
        <label>Magic Level</label>
        <input id="magicLevel" type="number" value="49">
      </div>

      <div>
        <label>Distance</label>
        <input id="distance" type="number" value="150">
      </div>

      <div>
        <label>Pontos Dmg/Healing Roda</label>
        <input id="pontosWheel" type="number" value="33">
      </div>

      <div>
        <label>Chance de crítico (%)</label>
        <input id="chanceCrit" type="number" step="0.01" value="12">
      </div>

      <div>
        <label>Chance ativação legs (%)</label>
        <input id="chanceLegs" type="number" step="0.01" value="0.44">
      </div>

      <div>
        <label>Base mas san (roda + gemas) (%)</label>
        <input id="baseMasSan" type="number" step="0.1" value="8.5">
      </div>

      <div>
        <label>Flechas/hora</label>
        <input id="flechasHora" type="number" value="1600">
      </div>

      <div>
        <label>Dano sofrido por Sagrado (%)</label>
        <input id="holyWeak" type="number" step="1" value="100">
      </div>

      <div>
        <label>Dano sofrido por Físico (%)</label>
        <input id="physWeak" type="number" step="1" value="100">
      </div>

      <div class="full toolbar">
        <button class="btn" id="shareBtn">Compartilhar</button>
        <button class="btn gray" id="clearBtn">Limpar</button>
        <span class="muted" id="statusText"></span>
      </div>
    </div>

    <div class="results-group" id="groupResumo">
      <h3>Resumo</h3>
      <div class="grid">
        <div class="result"><div>Level dmg: <span id="outF14">--</span></div></div>
        <div class="result"><div>Base dmg: <span id="outF15">--</span></div></div>
        <div class="result"><div>Chance crítico ajustada: <span id="outF16">--</span></div></div>
        <div class="result"><div>Bônus legs → avatar 3: <span id="outF17">--</span></div></div>
      </div>
    </div>

    <!-- NOVO: Stage 4 em layout nome | valor -->
    <div class="results-group" id="groupStage4">
      <h3>Stage 4 <span class="pill" id="pillStage4" style="display:none">MAIOR</span></h3>
      <ul class="perk-list">
        <li class="perk-card" id="cardF20" title="">
          <div class="perk-card__name" id="labelF20">+4% base damage para Divine Caldera</div>
          <div class="perk-card__value"><span class="perk-card__num" id="outF20">--</span></div>
          <div class="perk-card__badge">melhor do stage</div>
        </li>
        <li class="perk-card" id="cardF21" title="">
          <div class="perk-card__name" id="labelF21">+20% critical extra damage para Divine Caldera</div>
          <div class="perk-card__value"><span class="perk-card__num" id="outF21">--</span></div>
          <div class="perk-card__badge">melhor do stage</div>
        </li>
      </ul>
    </div>

    <!-- NOVO: Stage 5 em layout nome | valor -->
    <div class="results-group" id="groupStage5">
      <h3>Stage 5 <span class="pill" id="pillStage5" style="display:none">MAIOR</span></h3>
      <ul class="perk-list">
        <li class="perk-card" id="cardF24" title="">
          <div class="perk-card__name" id="labelF24">+3% critical hit chance para Divine Caldera</div>
          <div class="perk-card__value"><span class="perk-card__num" id="outF24">--</span></div>
          <div class="perk-card__badge">melhor do stage</div>
        </li>
        <li class="perk-card" id="cardF25" title="">
          <div class="perk-card__name" id="labelF25">+10% Distance Fighting p/ spells</div>
          <div class="perk-card__value"><span class="perk-card__num" id="outF25">--</span></div>
          <div class="perk-card__badge">melhor do stage</div>
        </li>
        <li class="perk-card" id="cardF26" title="">
          <div class="perk-card__name" id="labelF26">+2 attack</div>
          <div class="perk-card__value"><span class="perk-card__num" id="outF26">--</span></div>
          <div class="perk-card__badge">melhor do stage</div>
        </li>
      </ul>
    </div>
  </div>

  <script>
    // === Utils ===
    function getNum(id){
      const el = document.getElementById(id);
      const s = String(el.value).replace(',', '.');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    // % → fração (12 => 0.12)
    function getPctFraction(id){
      let s = String(document.getElementById(id).value).trim().replace(',', '.');
      if (s.endsWith('%')) s = s.slice(0,-1);
      const n = Number(s);
      return Number.isFinite(n) ? n/100 : 0;
    }
    // % → multiplicador (100 => 1, 120 => 1.2)
    function getPctMultiplier(id){
      let s = String(document.getElementById(id).value).trim().replace(',', '.');
      if (s.endsWith('%')) s = s.slice(0,-1);
      const n = Number(s);
      return Number.isFinite(n) ? n/100 : 0;
    }
    function setText(id, text){ document.getElementById(id).innerText = text; }
    function clearHighlights(){
      ['cardF20','cardF21','cardF24','cardF25','cardF26'].forEach(id=>{
        document.getElementById(id).classList.remove('is-best');
      });
      document.getElementById('pillStage4').style.display = 'none';
      document.getElementById('pillStage5').style.display = 'none';
    }

    // Formatadores (PT/EN) com números tabulados
    function currentLang(){
      try{
        const saved = localStorage.getItem("calc_lang");
        if(saved) return saved;
      }catch(e){}
      return "pt";
    }
    function numberFormatter(){
      const lang = currentLang()==='en' ? 'en-US' : 'pt-BR';
      return new Intl.NumberFormat(lang, { minimumFractionDigits: 2, maximumFractionDigits: 3 });
    }
    const fmtCache = { get(){ this._fmt = this._fmt || numberFormatter(); return this._fmt; }, reset(){ this._fmt = null; } };

    // === FÓRMULAS ===
    function calcF14(F2){
      if (F2 < 500)  return Math.floor(F2/5);
      if (F2 < 1100) return Math.floor((F2-500)/6 + 100);
      if (F2 < 1800) return Math.floor((F2-1100)/7 + 200);
      if (F2 < 2600) return Math.floor((F2-1800)/8 + 300);
      return Math.floor((F2-2600)/9 + 400);
    }
    function calcF15(F3, F8){ return Math.floor(F3*140*(1+F8)/25 + 140*(1+F8)/4); }
    function calcF16(F9, F7, F6){
      const part1 = Math.floor(F9*F7*6);
      const part2 = Math.floor(((F9*2) - part1) * F6);
      return (part1 + part2) / (F9*2);
    }
    function calcF17(F9, F7){
      const part1 = Math.floor(F9*F7*6);
      return (part1 * 15 / (F9*2)) / 100;
    }
    function calcF20(F14, F3, F8, F5, F16, F17){
      const baseRight = Math.floor(F3*140*(1+F8+0.04)/25 + 140*(1+F8+0.04)/4);
      return (F14 + baseRight + F5) * (1 + (F16)*0.8 + F17);
    }
    function calcF21(F14, F15, F5, F16, F17){
      return (F14 + F15 + F5) * (1 + (F16 + F17));
    }
    function calcF24(F14, F15, F5, F11){ return (F14 + F15 + F5) * 0.03 * 0.25 * F11; }
    function calcF25(F21, F20, F4, F11){
      const base = Math.round(F4*0.1);
      const mult = (F21 > F20) ? (0.2485*1.12 + 0.0435*1.0864) : (0.2485*1.096 + 0.0435*1.0864);
      return base * mult * F11;
    }
    function calcF26(F4, F12){
      const innerA = Math.floor((6/5)*48);
      const innerB = Math.floor((6/5)*46);
      const termA = Math.floor(innerA * (Math.floor(F4) + 4) / 28);
      const termB = Math.floor(innerB * (Math.floor(F4) + 4) / 28);
      const diff = termA - termB;
      return diff * 0.5 * 1.0864 * F12;
    }

    // === Execução ===
    function rodarCalculadora(){
      const F2  = getNum('level');
      const F3  = getNum('magicLevel');
      const F4  = getNum('distance');
      const F5  = getNum('pontosWheel');
      const F6  = getPctFraction('chanceCrit');      // % → fração
      const F7  = getPctFraction('chanceLegs');      // % → fração
      const F8  = getPctFraction('baseMasSan');      // % → fração
      const F9  = getNum('flechasHora');
      const F11 = getPctMultiplier('holyWeak');      // % → multiplicador
      const F12 = getPctMultiplier('physWeak');      // % → multiplicador

      const F14 = calcF14(F2);
      const F15 = calcF15(F3, F8);
      const F16 = calcF16(F9, F7, F6);
      const F17 = calcF17(F9, F7);
      const F20 = calcF20(F14, F3, F8, F5, F16, F17);
      const F21 = calcF21(F14, F15, F5, F16, F17);
      const F24 = calcF24(F14, F15, F5, F11);
      const F25 = calcF25(F21, F20, F4, F11);
      const F26 = calcF26(F4, F12);

      // Resumo
      setText('outF14', F14);
      setText('outF15', F15);
      setText('outF16', (F16*100).toFixed(4) + ' %');
      setText('outF17', (F17*100).toFixed(4) + ' %');

      // Valores formatados (tabular) para perks
      const fmt = fmtCache.get();
      document.getElementById('outF20').textContent = fmt.format(F20);
      document.getElementById('outF21').textContent = fmt.format(F21);
      document.getElementById('outF24').textContent = fmt.format(F24);
      document.getElementById('outF25').textContent = fmt.format(F25);
      document.getElementById('outF26').textContent = fmt.format(F26);

      try{ localStorage.setItem('calc_state', JSON.stringify({F2,F3,F4,F5,F6,F7,F8,F9,F11,F12})); }catch(e){}

      // Destaques (winners)
      clearHighlights();
      const winnerStage4 = (F20 >= F21) ? 'cardF20' : 'cardF21';
      document.getElementById(winnerStage4).classList.add('is-best');
      document.getElementById('pillStage4').style.display = 'inline-block';

      let winner5 = 'cardF24'; let max5 = F24;
      if(F25 > max5){ winner5='cardF25'; max5 = F25; }
      if(F26 > max5){ winner5='cardF26'; max5 = F26; }
      document.getElementById(winner5).classList.add('is-best');
      document.getElementById('pillStage5').style.display = 'inline-block';
    }

    // Deep link share
    function buildShareURL(){
      const raw = {
        level: document.getElementById('level').value,
        magicLevel: document.getElementById('magicLevel').value,
        distance: document.getElementById('distance').value,
        pontosWheel: document.getElementById('pontosWheel').value,
        chanceCrit: document.getElementById('chanceCrit').value,
        chanceLegs: document.getElementById('chanceLegs').value,
        baseMasSan: document.getElementById('baseMasSan').value,
        flechasHora: document.getElementById('flechasHora').value,
        holyWeak: document.getElementById('holyWeak').value,
        physWeak: document.getElementById('physWeak').value,
      };
      const params = new URLSearchParams(raw);
      const base = window.location.origin + window.location.pathname;
      return base + '?' + params.toString();
    }

    async function doShare(){
      const lang = currentLang();
      const t = i18n[lang] || i18n.pt;
      const url = buildShareURL();
      const txt = [
        t.shareSummary + ":",
        t.summary.f14 + ": " + document.getElementById("outF14").innerText,
        t.summary.f15 + ": " + document.getElementById("outF15").innerText,
        t.summary.f16 + ": " + document.getElementById("outF16").innerText,
        t.summary.f17 + ": " + document.getElementById("outF17").innerText,
        t.groups.stage4 + " – " + document.getElementById("labelF20").innerText + ": " + document.getElementById("outF20").innerText,
        t.groups.stage4 + " – " + document.getElementById("labelF21").innerText + ": " + document.getElementById("outF21").innerText,
        t.groups.stage5 + " – " + document.getElementById("labelF24").innerText + ": " + document.getElementById("outF24").innerText,
        t.groups.stage5 + " – " + document.getElementById("labelF25").innerText + ": " + document.getElementById("outF25").innerText,
        t.groups.stage5 + " – " + document.getElementById("labelF26").innerText + ": " + document.getElementById("outF26").innerText
      ].join("\n");

      if (navigator.share){
        try{
          await navigator.share({ title: t.shareTitle, text: txt, url });
          document.getElementById('statusText').innerText = (lang === "en" ? "Shared!" : "Compartilhado!");
          setTimeout(()=> document.getElementById('statusText').innerText = '', 1500);
          return;
        }catch(e){ /* fallback */ }
      }
      try{
        await navigator.clipboard.writeText(url);
        document.getElementById('statusText').innerText = (lang === "en" ? "Link copied ✔" : "Link copiado ✔");
        setTimeout(()=> document.getElementById('statusText').innerText = '', 1500);
      }catch(e){
        document.getElementById('statusText').innerText = url;
      }
    }

    // Eventos
    const ids = ['level','magicLevel','distance','pontosWheel','chanceCrit','chanceLegs','baseMasSan','flechasHora','holyWeak','physWeak'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', rodarCalculadora);
      el.addEventListener('change', rodarCalculadora);
    });
    document.getElementById('clearBtn').addEventListener('click', () => {
      ids.forEach(id => document.getElementById(id).value = '');
      ['outF14','outF15','outF16','outF17','outF20','outF21','outF24','outF25','outF26'].forEach(id => setText(id, '--'));
      try{ localStorage.removeItem('calc_state'); }catch(e){}
      clearHighlights();
      document.getElementById('statusText').innerText = '';
    });
    document.getElementById('shareBtn').addEventListener('click', doShare);

    // === i18n ===
    const i18n = {
      pt: {
        appTitle: "Calculadora Perks Sanguine Bow",
        title: "Calculadora Perks Sanguine Bow",
        buttons: { share: "Compartilhar", reset: "Limpar", lang: "English" },
        groups: { resumo: "Resumo", stage4: "Stage 4", stage5: "Stage 5" },
        labels: {
          level: "Level",
          magicLevel: "Magic Level",
          distance: "Distance",
          pontosWheel: "Pontos Dmg/Healing Roda",
          chanceCrit: "Chance de crítico (%)",
          chanceLegs: "Chance ativação legs (%)",
          baseMasSan: "Base mas san (roda + gemas) (%)",
          flechasHora: "Flechas/hora",
          holyWeak: "Dano sofrido por Sagrado (%)",
          physWeak: "Dano sofrido por Físico (%)"
        },
        summary: {
          f14: "Level dmg",
          f15: "Base dmg",
          f16: "Chance crítico ajustada",
          f17: "Bônus legs → avatar 3"
        },
        stage4: {
          f20: "+4% base damage para Divine Caldera",
          f21: "+20% critical extra damage para Divine Caldera"
        },
        stage5: {
          f24: "+3% critical hit chance para Divine Caldera",
          f25: "+10% Distance Fighting p/ spells",
          f26: "+2 attack"
        },
        shareTitle: "Minha simulação — Calculadora",
        shareSummary: "Resumo"
      },
      en: {
        appTitle: "Sanguine Bow Proficiency Calculator",
        title: "Sanguine Bow Proficiency Calculator",
        buttons: { share: "Share", reset: "Reset", lang: "Português" },
        groups: { resumo: "Resume", stage4: "Stage 4", stage5: "Stage 5" },
        labels: {
          level: "Level",
          magicLevel: "Magic Level",
          distance: "Distance",
          pontosWheel: "Dmg/Healing from Wheel",
          chanceCrit: "Critical chance (%)",
          chanceLegs: "Trancendence Triggering Chance (legs) (%)",
          baseMasSan: "Base mas san (wheel + gems) (%)",
          flechasHora: "Arrows/hour",
          holyWeak: "Damage taken from Holy (%)",
          physWeak: "Damage taken from Physical (%)"
        },
        summary: {
          f14: "Level dmg",
          f15: "Base dmg",
          f16: "Ajusted Critical Chance",
          f17: "Transcendence avatar 3 Bonus"
        },
        stage4: {
          f20: "+4% base damage for Divine Caldera",
          f21: "+20% critical extra damage for Divine Caldera"
        },
        stage5: {
          f24: "+3% critical hit chance for Divine Caldera",
          f25: "+10% Distance Fighting as extra damage for spells",
          f26: "+2 attack"
        },
        shareTitle: "My simulation — Calculator",
        shareSummary: "Resume"
      }
    };

    function applyLang(lang){
      const t = i18n[lang] || i18n.pt;
      // title e header
      document.title = t.appTitle + " — versão web";
      const h2 = document.querySelector(".card h2"); if(h2) h2.textContent = t.title;

      // Botões
      const shareBtn = document.getElementById("shareBtn"); if(shareBtn) shareBtn.textContent = t.buttons.share;
      const clearBtn = document.getElementById("clearBtn"); if(clearBtn) clearBtn.textContent = t.buttons.reset;
      const langBtn = document.getElementById("langBtn"); if(langBtn) langBtn.textContent = t.buttons.lang;

      // Grupos
      const gResumo = document.querySelector("#groupResumo h3"); if(gResumo) gResumo.textContent = t.groups.resumo;
      const g4 = document.querySelector("#groupStage4 h3"); if(g4) g4.firstChild.nodeValue = t.groups.stage4 + " ";
      const g5 = document.querySelector("#groupStage5 h3"); if(g5) g5.firstChild.nodeValue = t.groups.stage5 + " ";

      // Labels de inputs
      const labelOf = (id) => document.getElementById(id)?.previousElementSibling;
      const L = t.labels;
      const map = {
        level: L.level,
        magicLevel: L.magicLevel,
        distance: L.distance,
        pontosWheel: L.pontosWheel,
        chanceCrit: L.chanceCrit,
        chanceLegs: L.chanceLegs,
        baseMasSan: L.baseMasSan,
        flechasHora: L.flechasHora,
        holyWeak: L.holyWeak,
        physWeak: L.physWeak,
      };
      Object.entries(map).forEach(([id, text]) => {
        const lab = labelOf(id);
        if(lab) lab.textContent = text;
      });

      // Resumo (prefixos antes dos spans)
      const setPrefix = (outId, txt) => {
        const span = document.getElementById(outId);
        if(span && span.parentElement){
          span.parentElement.innerHTML = txt + ": <span id='" + outId + "'>" + span.textContent + "</span>";
        }
      };
      setPrefix("outF14", t.summary.f14);
      setPrefix("outF15", t.summary.f15);
      setPrefix("outF16", t.summary.f16);
      setPrefix("outF17", t.summary.f17);

      // NOVO: nomes dos perks (sem alterar os valores)
      document.getElementById("labelF20").textContent = t.stage4.f20;
      document.getElementById("labelF21").textContent = t.stage4.f21;
      document.getElementById("labelF24").textContent = t.stage5.f24;
      document.getElementById("labelF25").textContent = t.stage5.f25;
      document.getElementById("labelF26").textContent = t.stage5.f26;

      // lang attr + reset do formatador numérico
      document.documentElement.lang = (lang === "en" ? "en" : "pt-BR");
      fmtCache.reset(); // garante separadores corretos
      rodarCalculadora(); // recalcula com novo formatter
      try{ localStorage.setItem("calc_lang", lang); }catch(e){}
    }

    // Toggle language button + boot
    document.getElementById("langBtn").addEventListener("click", () => {
      const lang = currentLang();
      const next = (lang === "en") ? "pt" : "en";
      applyLang(next);
    });
    (function initLang(){ applyLang(currentLang()); })();

    // Boot: restaurar da URL/localStorage e calcular
    (function restoreAndRun(){
      const params = new URLSearchParams(window.location.search);
      if(params && Array.from(params.keys()).length){
        const set = (id, key) => { if(params.has(key)) document.getElementById(id).value = params.get(key); };
        set('level','level'); set('magicLevel','magicLevel'); set('distance','distance'); set('pontosWheel','pontosWheel');
        set('chanceCrit','chanceCrit'); set('chanceLegs','chanceLegs'); set('baseMasSan','baseMasSan'); set('flechasHora','flechasHora');
        set('holyWeak','holyWeak'); set('physWeak','physWeak');
      }else{
        try{
          const raw = localStorage.getItem('calc_state');
          if(raw){
            const st = JSON.parse(raw);
            const set = (id, val) => { if (val !== undefined && val !== null) document.getElementById(id).value = val; };
            set('level', st.F2); set('magicLevel', st.F3); set('distance', st.F4); set('pontosWheel', st.F5);
            if(st.F6!=null) document.getElementById('chanceCrit').value = (st.F6*100).toString();
            if(st.F7!=null) document.getElementById('chanceLegs').value = (st.F7*100).toString();
            if(st.F8!=null) document.getElementById('baseMasSan').value = (st.F8*100).toString();
            set('flechasHora', st.F9);
            if(st.F11!=null) document.getElementById('holyWeak').value = (st.F11*100).toString();
            if(st.F12!=null) document.getElementById('physWeak').value = (st.F12*100).toString();
          }
        }catch(e){}
      }
      rodarCalculadora();
    })();
  </script>
</body>
</html>
