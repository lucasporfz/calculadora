<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Calculadora — versão web</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#f4f6f9; color:#111; padding:24px; }
    .card { max-width:980px; margin:18px auto; background:white; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    label { display:block; font-size:13px; color:#333; margin-bottom:6px; }
    input[type=number] { width:100%; padding:8px 10px; border-radius:8px; border:1px solid #ddd; font-size:14px; }
    .full { grid-column: 1 / -1; }
    .btn { padding:10px 14px; background:#2563eb; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn.gray { background:#6b7280; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    .results-group { margin-top:14px; padding:12px; background:#fafafa; border:1px solid #eee; border-radius:10px; }
    .results-group h3 { margin:0 0 10px; font-size:16px; }
    .result { background:white; padding:12px; border-radius:8px; border:1px solid #eee; font-weight:600; }
    .muted { color:#666; font-weight:500; }
    .winner { border:2px solid #16a34a !important; box-shadow:0 0 0 3px rgba(22,163,74,0.15); }
    .pill { display:inline-block; font-size:11px; padding:3px 6px; border-radius:999px; background:#eef2ff; color:#3730a3; margin-left:6px; font-weight:700; }
    @media (max-width: 720px){ .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="card">
    <h2>Calculadora</h2>

    <div class="grid">
      <div>
        <label>Level</label>
        <input id="level" type="number" value="1000">
      </div>

      <div>
        <label>Magic Level</label>
        <input id="magicLevel" type="number" value="48">
      </div>

      <div>
        <label>Distance</label>
        <input id="distance" type="number" value="150">
      </div>

      <div>
        <label>Pontos Wheel</label>
        <input id="pontosWheel" type="number" value="11">
      </div>

      <div>
        <label>Chance de crítico (%)</label>
        <input id="chanceCrit" type="number" step="0.01" value="12">
      </div>

      <div>
        <label>Chance ativação legs (%)</label>
        <input id="chanceLegs" type="number" step="0.01" value="0.98">
      </div>

      <div>
        <label>Base mas san (wheel + gemas) (%)</label>
        <input id="baseMasSan" type="number" step="0.1" value="7.5">
      </div>

      <div>
        <label>Flechas/hora</label>
        <input id="flechasHora" type="number" value="1650">
      </div>

      <div>
        <label>Holy weakness (%)</label>
        <input id="holyWeak" type="number" step="1" value="100">
      </div>

      <div>
        <label>Physical weakness (%)</label>
        <input id="physWeak" type="number" step="1" value="100">
      </div>

      <div class="full toolbar">
        <button class="btn" id="shareBtn">Compartilhar</button>
        <button class="btn gray" id="clearBtn">Limpar</button>
        <span class="muted" id="statusText"></span>
      </div>
    </div>

    <div class="results-group" id="groupResumo">
      <h3>Resumo</h3>
      <div class="grid">
        <div class="result"><div>Level dmg: <span id="outF14">--</span></div></div>
        <div class="result"><div>Base dmg: <span id="outF15">--</span></div></div>
        <div class="result"><div>Chance crítico ajustada: <span id="outF16">--</span></div></div>
        <div class="result"><div>Bônus legs → avatar 3: <span id="outF17">--</span></div></div>
      </div>
    </div>

    <div class="results-group" id="groupStage4">
      <h3>Stage 4 <span class="pill" id="pillStage4" style="display:none">MAIOR</span></h3>
      <div class="grid">
        <div class="result" id="cardF20"><div>+4% base damage para Divine Caldera: <span id="outF20">--</span></div></div>
        <div class="result" id="cardF21"><div>+20% critical extra damage para Divine Caldera: <span id="outF21">--</span></div></div>
      </div>
    </div>

    <div class="results-group" id="groupStage5">
      <h3>Stage 5 <span class="pill" id="pillStage5" style="display:none">MAIOR</span></h3>
      <div class="grid">
        <div class="result" id="cardF24"><div>+3% critical hit chance para Divine Caldera: <span id="outF24">--</span></div></div>
        <div class="result" id="cardF25"><div>+10% Distance Fighting p/ spells: <span id="outF25">--</span></div></div>
        <div class="result full" id="cardF26"><div>+2 attack: <span id="outF26">--</span></div></div>
      </div>
    </div>
  </div>

  <script>
    // === Utils ===
    function getNum(id){
      const el = document.getElementById(id);
      const s = String(el.value).replace(',', '.');
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    // % → fração (12 => 0.12)
    function getPctFraction(id){
      let s = String(document.getElementById(id).value).trim().replace(',', '.');
      if (s.endsWith('%')) s = s.slice(0,-1);
      const n = Number(s);
      return Number.isFinite(n) ? n/100 : 0;
    }
    // % → multiplicador (100 => 1, 120 => 1.2)
    function getPctMultiplier(id){
      let s = String(document.getElementById(id).value).trim().replace(',', '.');
      if (s.endsWith('%')) s = s.slice(0,-1);
      const n = Number(s);
      return Number.isFinite(n) ? n/100 : 0;
    }
    function setText(id, text){ document.getElementById(id).innerText = text; }
    function mround(value, multiple){
      if(!Number.isFinite(value) || !Number.isFinite(multiple) || multiple === 0) return NaN;
      return Math.round(value / multiple) * multiple;
    }
    function clearHighlights(){
      ['cardF20','cardF21','cardF24','cardF25','cardF26'].forEach(id=>{
        document.getElementById(id).classList.remove('winner')
      });
      document.getElementById('pillStage4').style.display = 'none';
      document.getElementById('pillStage5').style.display = 'none';
    }

    // === FÓRMULAS ===
    function calcF14(F2){
      if (F2 < 500)  return mround(F2/5, 1);
      if (F2 < 1100) return mround((F2-500)/6 + 100, 1);
      if (F2 < 1800) return mround((F2-1100)/7 + 200, 1);
      if (F2 < 2600) return mround((F2-1800)/8 + 300, 1);
      return mround((F2-2600)/9 + 400, 1);
    }
    function calcF15(F3, F8){ return Math.floor(F3*140*(1+F8)/25 + 140*(1+F8)/4); }
    function calcF16(F9, F7, F6){
      const part1 = Math.floor(F9*F7*6);
      const part2 = Math.floor(((F9*2) - part1) * F6);
      return (part1 + part2) / (F9*2);
    }
    function calcF17(F9, F7){
      const part1 = Math.floor(F9*F7*6);
      return (part1 * 15 / (F9*2)) / 100;
    }
    function calcF20(F14, F3, F8, F5, F16, F17){
      const baseRight = Math.floor(F3*140*(1+F8+0.04)/25 + 140*(1+F8+0.04)/4);
      return (F14 + baseRight + F5) * (1 + (F16)*0.8 + F17);
    }
    function calcF21(F14, F15, F5, F16, F17){
      return (F14 + F15 + F5) * (1 + (F16 + F17));
    }
    function calcF24(F14, F15, F5, F11){ return (F14 + F15 + F5) * 0.03 * 0.25 * F11; }
    function calcF25(F21, F20, F4, F11){
      const base = Math.round(F4*0.1);
      const mult = (F21 > F20) ? (0.2485*1.12 + 0.0435*1.0864) : (0.2485*1.096 + 0.0435*1.0864);
      return base * mult * F11;
    }
    function calcF26(F4, F12){
      const innerA = Math.floor((6/5)*48);
      const innerB = Math.floor((6/5)*46);
      const termA = Math.floor(innerA * (Math.floor(F4) + 4) / 28);
      const termB = Math.floor(innerB * (Math.floor(F4) + 4) / 28);
      const diff = termA - termB;
      return diff * 0.5 * 1.0864 * F12;
    }

    // === Execução ===
    function rodarCalculadora(){
      const F2  = getNum('level');
      const F3  = getNum('magicLevel');
      const F4  = getNum('distance');
      const F5  = getNum('pontosWheel');
      const F6  = getPctFraction('chanceCrit');      // % → fração
      const F7  = getPctFraction('chanceLegs');      // % → fração
      const F8  = getPctFraction('baseMasSan');      // % → fração
      const F9  = getNum('flechasHora');
      const F11 = getPctMultiplier('holyWeak');      // % → multiplicador
      const F12 = getPctMultiplier('physWeak');      // % → multiplicador

      const F14 = calcF14(F2);
      const F15 = calcF15(F3, F8);
      const F16 = calcF16(F9, F7, F6);
      const F17 = calcF17(F9, F7);
      const F20 = calcF20(F14, F3, F8, F5, F16, F17);
      const F21 = calcF21(F14, F15, F5, F16, F17);
      const F24 = calcF24(F14, F15, F5, F11);
      const F25 = calcF25(F21, F20, F4, F11);
      const F26 = calcF26(F4, F12);

      setText('outF14', F14);
      setText('outF15', F15);
      setText('outF16', (F16*100).toFixed(4) + ' %');
      setText('outF17', (F17*100).toFixed(4) + ' %');
      setText('outF20', Number(F20.toFixed(6)));
      setText('outF21', Number(F21.toFixed(6)));
      setText('outF24', Number(F24.toFixed(6)));
      setText('outF25', Number(F25.toFixed(6)));
      setText('outF26', Number(F26.toFixed(6)));

      try{ localStorage.setItem('calc_state', JSON.stringify({F2,F3,F4,F5,F6,F7,F8,F9,F11,F12})); }catch(e){}

      // Destaques (winners)
      clearHighlights();
      const winnerStage4 = (F20 >= F21) ? 'cardF20' : 'cardF21';
      document.getElementById(winnerStage4).classList.add('winner');
      document.getElementById('pillStage4').style.display = 'inline-block';

      let winner5 = 'cardF24'; let max5 = F24;
      if(F25 > max5){ winner5='cardF25'; max5 = F25; }
      if(F26 > max5){ winner5='cardF26'; max5 = F26; }
      document.getElementById(winner5).classList.add('winner');
      document.getElementById('pillStage5').style.display = 'inline-block';
    }

    // Deep link share
    function buildShareURL(){
      const raw = {
        level: document.getElementById('level').value,
        magicLevel: document.getElementById('magicLevel').value,
        distance: document.getElementById('distance').value,
        pontosWheel: document.getElementById('pontosWheel').value,
        chanceCrit: document.getElementById('chanceCrit').value,
        chanceLegs: document.getElementById('chanceLegs').value,
        baseMasSan: document.getElementById('baseMasSan').value,
        flechasHora: document.getElementById('flechasHora').value,
        holyWeak: document.getElementById('holyWeak').value,
        physWeak: document.getElementById('physWeak').value,
      };
      const params = new URLSearchParams(raw);
      const base = window.location.origin + window.location.pathname;
      return base + '?' + params.toString();
    }
    function restoreFromURL(){
      const params = new URLSearchParams(window.location.search);
      if(!params || Array.from(params.keys()).length === 0) return;
      const set = (id, key) => { if(params.has(key)) document.getElementById(id).value = params.get(key); };
      set('level','level'); set('magicLevel','magicLevel'); set('distance','distance'); set('pontosWheel','pontosWheel');
      set('chanceCrit','chanceCrit'); set('chanceLegs','chanceLegs'); set('baseMasSan','baseMasSan'); set('flechasHora','flechasHora');
      set('holyWeak','holyWeak'); set('physWeak','physWeak');
    }
    async function doShare(){
      const url = buildShareURL();
      if (navigator.share){
        try{
          await navigator.share({ title: 'Minha simulação — Calculadora', url });
          document.getElementById('statusText').innerText = 'Compartilhado!';
          setTimeout(()=> document.getElementById('statusText').innerText = '', 1500);
          return;
        }catch(e){ /* fallback */ }
      }
      try{
        await navigator.clipboard.writeText(url);
        document.getElementById('statusText').innerText = 'Link copiado ✔';
        setTimeout(()=> document.getElementById('statusText').innerText = '', 1500);
      }catch(e){
        document.getElementById('statusText').innerText = url;
      }
    }

    // Eventos
    const ids = ['level','magicLevel','distance','pontosWheel','chanceCrit','chanceLegs','baseMasSan','flechasHora','holyWeak','physWeak'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', rodarCalculadora);
      el.addEventListener('change', rodarCalculadora);
    });
    document.getElementById('clearBtn').addEventListener('click', () => {
      ids.forEach(id => document.getElementById(id).value = '');
      ['outF14','outF15','outF16','outF17','outF20','outF21','outF24','outF25','outF26'].forEach(id => setText(id, '--'));
      try{ localStorage.removeItem('calc_state'); }catch(e){}
      clearHighlights();
      document.getElementById('statusText').innerText = '';
    });
    document.getElementById('shareBtn').addEventListener('click', doShare);

    // Boot: restaurar da URL/localStorage e calcular
    (function restoreAndRun(){
      restoreFromURL();
      try{
        const raw = localStorage.getItem('calc_state');
        if(raw && window.location.search.length === 0){
          const st = JSON.parse(raw);
          const set = (id, val) => { if (val !== undefined && val !== null) document.getElementById(id).value = val; };
          set('level', st.F2); set('magicLevel', st.F3); set('distance', st.F4); set('pontosWheel', st.F5);
          if(st.F6!=null) document.getElementById('chanceCrit').value = (st.F6*100).toString();
          if(st.F7!=null) document.getElementById('chanceLegs').value = (st.F7*100).toString();
          if(st.F8!=null) document.getElementById('baseMasSan').value = (st.F8*100).toString();
          set('flechasHora', st.F9);
          if(st.F11!=null) document.getElementById('holyWeak').value = (st.F11*100).toString();
          if(st.F12!=null) document.getElementById('physWeak').value = (st.F12*100).toString();
        }
      }catch(e){}
      rodarCalculadora();
    })();
  </script>
</body>
</html>
